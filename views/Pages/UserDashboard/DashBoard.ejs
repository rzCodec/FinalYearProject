<!DOCTYPE html>
<html lang="en" >
<head >
    <%- include ../../Partials/AboveFold.ejs %>
</head >
<body >
<%- include ./partials/nav.ejs %>

<main  class=" lighten-3">
    <%-include ../../Partials/UserInfo.ejs%>
    <div class="row" style="margin-left: 17%; margin-top: 1%" >

        <div class="col s7 offset-s1" >
            <ul id="staggered-test" >
                <li class="" style="transform: translateX(0px); opacity: 0; "  >
                    <div class="card white darken-1"
                         style="background:  url('images/background/background3.jpg');background-size: cover;" >
                        <div class="card-content" >

                            <span class="card-title center-align" >
                            <a href="/profile"><img class="circle" src="images/profilePics/<%=UserInfo.info.id%>.png"
                                style="height: 15%;width:15%;border-color: red; border: groove"></a>
                                <h2 id=" Welcoming">Welcome <%=UserInfo.info.firstname%> <%=UserInfo.info.surname%></h2>
                            </span>
                        </div >
                    </div >
                </li >

                <form class="card ">

                    <div class="card-content input-field modal-trigger" data-target="PostStatus">
                        <i class="left material-icons">border_color</i>
                        What's the vibe? Share with your friends...
                    </div>
                </form>

                <div id="Timeline" class="card " style="margin-top: 5%;margin-bottom: 10%;
                    background-color: transparent; border: transparent" >
                    <div >
                        <ul id="posts" class="collection truncate collapsible"
                            data-collapsible="accordion" style="border: transparent; background-color: white">
                            <!--  DISPLAY FOLLOWING'S POSTS AND USER POSTS AND DIFFERENTIATE BETWEEN THEM -->
                            <%UserInfo.Status.forEach(function(status)
                            {
                                var msg = "Hey everyone, I think this post: '" + status.status + "' by "
                                    +  status.firstname + " " + status.surname + " aka "
                                    + status.username + " is pretty cool on Eternal Vibes";
                                if(status.user_id == UserInfo.info.id)
                                {%>
                                <li class="collection-item avatar black-text"
                                    style="border-bottom: groove; background-color: white">
                                    <div class="left-align collapsible-header" style="margin-top: 1%">
                                        <img src="images/profilePics/<%=status.user_id%>.png" alt=""
                                            class="circle" width="50%"  height="50%">
                                        <%var theDate = new Date(status.timestamp* 1000); %>
                                        <span class="title"><%=status.firstname%> <%=status.surname%> &emsp;
                                        </span><p>@<%=status.username%></p>
                                            &emsp; &emsp; &emsp; <%= theDate.getDate()%> <%= theDate.getMonth()%>

                                    </div>
                                    <br>
                                    <p class="flow-text"><%=status.status%></p>
                                    <br>
                                    (<%=status.liked%>) likes
                                    <hr>
                                    <div class="collapsible-body brown-text" style="background-color: white">
                                        <ul>
                                            <li id="like<%=status.id%>"
                                                class="collection-item brown white-text" onclick="LikeStatus(<%= status.id %>)">
                                                <i class="material-icons Small left-align tooltipped"
                                                   data-tooltip="Like Post">star_border
                                                </i>Like
                                            </li>
                                            <li id="del<%=status.id%>" class="collection-item red white-text"
                                                onclick="deleteStatus(<%= status.id %>)">
                                            <i class="material-icons Small left">delete</i>
                                            Delete
                                            </li>
                                            <li class="collection-item blue lighten-2 ">
                                                <a class="white-text"
                                                   href="https://twitter.com/intent/tweet?text=<%=msg%>">
                                                    Share on Twitter
                                                </a>
                                            </li>
                                            <li class="collection-item blue darken-2" >
                                                <a id="fb" class="white-text" onclick="Facebook(<%=msg%>)">
                                                    Share on Facebook
                                                </a>
                                            </li>
                                        </ul>
                                    </div>
                                </li>
                            <%}
                            else
                            {%>
                            <!-- CUSTOM OPTIONS FOR POSTS THAT ARENT FROM THE USER SUCH AS UNFOLLOW, REPORTING -->
                                <li class="collection-item avatar black-text"
                                    style="border-bottom: groove; background-color: white">

                                    <div class="left-align collapsible-header" style="margin-top: 1%;">
                                        <img src="images/profilePics/<%=status.user_id%>.png" alt="" class="circle">
                                        <%var theDate = new Date(status.timestamp* 1000); %>
                                        <span class="title"><%=status.firstname%> <%=status.surname%> &emsp;
                                            @<%=status.username%> &emsp; &emsp;&emsp;
                                            <%= theDate.getDate()%> <%= theDate.getMonth()%>
                                        </span>
                                    </div>
                                    <br>
                                    <p class="flow-text"><%=status.status%></p>
                                    <br>
                                    Likes (<%=status.liked%>)
                                    <hr>
                                    <div class="collapsible-body white-text" >
                                        <ul>
                                            <li class="center black-text"><h3>Post Oprions</h3></li>
                                            <li id="like<%=status.id%>"
                                                class="collection-item brown" onclick="LikeStatus(<%= status.id %>)">
                                                <i class="material-icons brown-text left-align tooltipped"
                                                   data-tooltip="Like Post">star_border
                                                </i>Like
                                            </li>
                                            <li class="collection-item red">
                                                <ul class="collapsible" data-collapsible="accordion"
                                                    style="border: none">
                                                    <li>
                                                        <div  class="collapsible-header transparent">Report Post</div>
                                                        <div class="collapsible-body">
                                                            <ul>
                                                                <li class="collection-item transparent">
                                                                    <a class="popout white-text">
                                                                        I do not like their content
                                                                    </a>
                                                                </li>
                                                                <li class="collection-item transparent">
                                                                    <a class="popout white-text">
                                                                        They are is inappropriate
                                                                    </a>
                                                                </li >
                                                                <li class="collection-item transparent">
                                                                    <a class="popout white-text">
                                                                        Post is spam
                                                                    </a>
                                                                </li>
                                                            </ul>
                                                        </div>
                                                    </li>
                                                </ul>
                                            </li>

                                            <li class="collection-item blue lighten-2 ">
                                                <a class="white-text"
                                                   href="https://twitter.com/intent/tweet?text=<%=msg%>">
                                                    Share on Twitter
                                                </a>
                                            </li>
                                            <li class="collection-item blue darken-2" >
                                                <a id="fb" class="white-text" onclick="Facebook(<%=msg%>)">
                                                    Share on Facebook
                                                </a>
                                            </li>
                                            <li class="collection-item orange collapsible"
                                                data-collapsible="accordion" >
                                                <ul class="collapsible" data-collapsible="accordion"
                                                    style="border: none">
                                                    <li>
                                                        <div  class="collapsible-header transparent">Report User</div>
                                                        <div class="collapsible-body">
                                                            <ul>
                                                                <li class="collection-item transparent white-text">
                                                                    <a href="" onclick="ReportUser(<%=status.user_id%>,
                                                                            $(this).value())">
                                                                        I do not like their content
                                                                    </a>
                                                                </li>
                                                                <li class="collection-item transparent white-text">
                                                                    <a href="" onclick="ReportUser(<%=status.user_id%>,
                                                                            $(this).value())">
                                                                        They are is inappropriate
                                                                    </a>
                                                                </li >
                                                                <li class="collection-item transparent white-text">
                                                                    <a href="" onclick="ReportUser(<%=status.user_id%>,
                                                                            $(this).value())">
                                                                        They are posting spam
                                                                    </a>
                                                                </li>
                                                                <li class="collection-item transparent white-text">
                                                                    <a href="" onclick="ReportUser(<%=status.user_id%>,
                                                                            $(this).value())">
                                                                        Their account is hacked
                                                                    </a>
                                                                </li>
                                                            </ul>
                                                        </div>
                                                    </li>
                                                </ul>
                                            </li>
                                            <li id="follow<%=status.user_id%>" class="collection-item brown"
                                                onclick="follow(<%=status.user_id%>)">Unfollow User</li>
                                        </ul>
                                    </div>
                                </li>
                            <hr>
                            <%}})%>
                        </ul>
                    </div >
                </div >

            </ul >
        </div >

<!-- DISPLAYS TOP ARTISTS AND GENRE STATISTICS TO THE USER -->
        <div class="col s4" >
            <ul id="staggered-test2" >
                <li class="" style="transform: translateX(0px); opacity: 0; margin-bottom: 4%" >
                    <div class="card white lighten-2 with-header" >
                        <div class="card-content" style="margin-bottom: 10%">
                            <span class="card-title collection-header" >Top Artists </span >
                        </div >
                        <ul class="collection collapsible popout" data-collapsible="accordion"
                            style="border: transparent;" >
                            <% UserInfo.TopArtists.forEach(function (output) { %>
                            <li class="collection-item avatar black-text"  style="background-color: white">
                                <%console.log(output)%>
                                <div class="collapsible-header">
                                    <img src="images/profilePics/<%= output.id %>.png"
                                         alt="<%output.username %>" class="circle" >
                                <span class="title" ><%= output.username %></span >

                                </div>
                                <p >Rank: <%= output.count %>
                                </p >
                                <div class="collapsible-body">
                                    <span>
                                        <a href="#" class="secondary-content" ><%= output.liked %></a >
                                    </span>
                                </div>
                            </li >
                            <% }); %>
                        </ul >
                    </div >
                    <div class="card white lighten-2" >
                        <div class="card-content white-text" >
                            <canvas id="myChart" width="400" height="400" ></canvas >
                        </div >
                    </div >
                </li >
            </ul >
        </div >
    </div >
    </div >
</main >
<div class=" hide-on-med-and-down" style="margin-left: 22% "><%- include ../../Partials/footer.ejs %></div>
<div class=" hide-on-large-only"><%- include ../../Partials/footer.ejs %></div>

<script >

    var userID = <%=UserInfo.info.id%>;
    $(document).ready(function(){
        $('.modal').modal();
        $('.slider').slider();
        $('.carousel').carousel();
        $('.collapsible').collapsible();
        $('.materialboxed').materialbox();

        setProfileImg(<%=UserInfo.info.id%>);

    });

    //CODE TO REPORT A USER
    function ReportUser(reportId, Reason)
    {

        $.post("https://eternalvibes.me/reportUser",
            {
                userThatReported: userID,
                userThatGotReported:reportId,
                reason: Reason
            },
            function (data)
            {
                console.log("Data: " + data);
                if(data == 200)
                {

                }
        });
        Materialize.toast('User has been Reported and will be evaluated');
    }

    //CODE TO FOLLOW/UNFOLLOW A USER
    function follow(followID)
    {
        if($('#follow'+followID).value() === "Unfollow User")
        {
            var link = "https://eternalvibes.me/stopFollowing/" + userID + "/" + followID;
            $.get(link,
                function (data)
                {
                    console.log("Data: " + data);
                    if (data == 200)
                    {

                    }
                });
            Materialize.toast('User Unfollowed');
            $('#follow'+unfollowID).value("Follow User");
        }
        else
        {
            var link = "https://eternalvibes.me/followUser/" + userID + "/" + followID;
            $.get(link,
                function (data)
                {
                    console.log("Data: " + data);
                    if(data == 200)
                    {

                    }
                });
            Materialize.toast('User now being followed');
            $('#follow'+unfollowID).value("Unfollow User");
        }
    }

    //SHARE A POST ON FACEBOOK
    function Facebook(cptn)
    {
        FB.ui({
                method: 'feed',
                link: 'https://eternalvibes.me',
                caption: cptn},
            function(response){}
            );
    }
  Materialize.showStaggeredList('#staggered-test');
  Materialize.showStaggeredList('#staggered-test2');


  var ctx = document.getElementById("myChart");
  var label = [];
  var count = [];
  var colours = [];

  <% UserInfo.TopGenres.forEach(function (output) { %>
  label.push("<%= output.name %>");
  count.push(<%= output.count %>);
  colours.push(hexToRGB('#' + intToRGB(hashCode('<%= output.name %>')), 0.7));
  <% }); %>

  var myChart = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: label,
      datasets: [
        {
          data: count,
          backgroundColor: colours
        }]
    }
  });

  function hashCode (str) { // java String#hashCode
    var hash = 0
    for (var i = 0; i < str.length; i++) {
      hash = str.charCodeAt(i) + ((hash << 5) - hash)
    }
    return hash
  }

  function intToRGB (i) {
    var c = (i & 0x00FFFFFF).toString(16).toUpperCase()

    return '00000'.substring(0, 6 - c.length) + c
  }

  function hexToRGB (hex, alpha) {
    var r = parseInt(hex.slice(1, 3), 16),
      g = parseInt(hex.slice(3, 5), 16),
      b = parseInt(hex.slice(5, 7), 16)

    if (alpha) {
      return 'rgba(' + r + ', ' + g + ', ' + b + ', ' + alpha + ')'
    } else {
      return 'rgb(' + r + ', ' + g + ', ' + b + ')'
    }
  }


</script >

</body >
</html >
